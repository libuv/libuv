name: CI-unix

on:
  pull_request:
    paths:
      - '**'
      - '!docs/**'
      - '!src/win/**'
      - '!.**'
      - '.github/workflows/CI-unix.yml'
  push:
    branches:
      - v[0-9].*
      - master

jobs:
  build-cross-qemu:
    runs-on: ubuntu-latest
    name: build-cross-qemu-${{ matrix.config.arch }}

    strategy:
      fail-fast: false
      matrix:
        config:
          - {arch: arm,       triple: arm-linux-gnueabi,          qemu: arm,      }
          - {arch: armhf,     triple: arm-linux-gnueabihf,        qemu: arm,      }
          - {arch: aarch64,   triple: aarch64-linux-gnu,          qemu: aarch64,  }
          - {arch: riscv64,   triple: riscv64-linux-gnu,          qemu: riscv64,  }
          - {arch: ppc,       triple: powerpc-linux-gnu,          qemu: ppc,      }
          - {arch: ppc64,     triple: powerpc64-linux-gnu,        qemu: ppc64,    }
          - {arch: ppc64el,   triple: powerpc64le-linux-gnu,      qemu: ppc64le,  }
          - {arch: s390x,     triple: s390x-linux-gnu,            qemu: s390x,    }
          - {arch: mips,      triple: mips-linux-gnu,             qemu: mips,     }
          - {arch: mips64,    triple: mips64-linux-gnuabi64,      qemu: mips64,   }
          - {arch: mipsel,    triple: mipsel-linux-gnu,           qemu: mipsel,   }
          - {arch: mips64el,  triple: mips64el-linux-gnuabi64,    qemu: mips64el, }
          - {arch: alpha,     triple: alpha-linux-gnu,            qemu: alpha,    }

    steps:
      - uses: actions/checkout@v2
      - name: Install ${{ matrix.config.toolchain }}
        run: |
          sudo apt update
          sudo apt install ninja-build -y
          sudo apt install gcc-${{ matrix.config.triple }} -y
          sudo mkdir /etc/qemu-binfmt
          sudo ln -s /usr/${{ matrix.config.triple }} /etc/qemu-binfmt/${{ matrix.config.qemu }}
          # QEMU developers have been arguing for years if they want to work around this glibc bug
          # so we will just implement our own workaround for it
          # https://bugs.launchpad.net/qemu/+bug/1701798
          sudo mkdir -p /usr/${{ matrix.config.triple }}/etc
          sudo touch /usr/${{ matrix.config.triple }}/etc/ld.so.cache
      - name: Install latest QEMU
        # this ensure install latest qemu on ubuntu, apt get version is old
        env:
          QEMU_SRC: "http://archive.ubuntu.com/ubuntu/pool/universe/q/qemu"
          QEMU_VER: "qemu-user-static_7\\.0+dfsg-.*_amd64.deb$"
        run: |
          DEB=`curl -s $QEMU_SRC/ | grep -o -E 'href="([^"#]+)"' | cut -d'"' -f2 | grep $QEMU_VER | tail -1`
          wget $QEMU_SRC/$DEB
          sudo dpkg -i $DEB
      - name: Configure with ${{ matrix.config.triple }}
        run: |
          cmake -S . -B build -G Ninja -DQEMU=ON -DBUILD_TESTING=ON -DCMAKE_C_COMPILER=${{ matrix.config.triple }}-gcc -DCMAKE_BUILD_WITH_INSTALL_RPATH=TRUE
      - name: Build
        run: |
          cmake --build build
          ls -lh build
      - name: Test
        run: |
          qemu-${{ matrix.config.qemu }}-static --version
          LD_LIBRARY_PATH=~+/build qemu-${{ matrix.config.qemu }}-static build/uv_run_tests_a
      - name: Test
        if: always()
        run: |
          LD_LIBRARY_PATH=~+/build qemu-${{ matrix.config.qemu }}-static build/uv_run_tests
